# CPSim
CPSim is a program designed to simulate the nervous system, for the Computational Physiology Lab at Cornell University. It is designed so that a user can build models in text files without having to interact with the code itself. 

##Tutorial:
###Running the code:
To run the simulator, the user must run main.py. It was designed to run on **Python 3.7**.\
To run CPSim, the following packages must be availible:
 - numpy
 - scipy
 - matplotlib
 - XlsxWriter

The user can build and edit models in text files, and can choose which text file the model is based on. 
####Choose which file to run:
There are multiple ways to choose which text file to run. These are all controlled by the file **metadata.txt**.
 - If metadata.txt does not exist in the same folder as main.py, the code will prompt the user to enter a file to run in the console. It will make a new metadata.txt file containing the file you ran. 
 - If metadata.txt does exist, it will ask the user if it wants to use the same file as the last time the code was run. If the user declines, it will then ask for a new file to run, and replace the file in metadata.txt with this new file. 

If the user wants to skip the file selection, the user can edit metadata.txt to have the word force on the first line. This will automatically use the file on the second line.
```
force
your_file_name.txt
``` 
###Building your first model:
Each model txt file must have the following structure:
```
Simulator_setup:
timestep 1
<Include general model details here. 
eg: how long the model will run for, should the model be saved, etc.>

Model_structure:
<Build all neurons and synapses here>

Parameters:
<Edit model parameters here. 
This includes the parameters for neurons and synapses, as well as external inputs>
```
To denote any line in the model as a comment line, the first character in that line must be a `#`.
```
# This is a comment line
```

####Simulator setup:
Simulator setup is used to specify general details in the model. It can contain the following commands:
 - `timestep <int>`: This denotes the size of one time step in the model in milliseconds. As of now, it is strongly recommended that the user use `timestep 1` only (time steps should be 1ms long). This command should be used exactly once in each model.
 - `final_timestep <int>`: This indicates how many timesteps the model should run for. This command should be used exactly once in each model.
 - `save_directory <str>`: This command is optional. If it is included, the simulator will save the model's state at the end of the simulation in the specified directory. This will include a new generated model txt file called state.txt, as well as a file called data.npz which will store other model data. If not included, the model will not save its state.
 - `load_directory <str>`: This command should only be used if this model already has a corresponding data.npz file generated by saving. It should point to the directory containing it. 
 - `keep_loaded_data <bool>`: Must be used if and only if `load_directory <str>` is used. If True, this will preserve data from the loaded save in the output of this simulation. If false it will only output newly computed data. Note that this command has no effect on the computation itself.
 
#####Saving and loading
 TODO
####Model Structure:
Model structure is used to build all neurons and synapses between them. In general, all neurons are built in groups, and each group is given a name which it can be referred to by. \
It contains the following commands:
 - `group <neuron type> <group name (str)> <number of neurons (int)>`:  
 This is the command used to build groups of neurons. It specifies the type of neurons being built, the name of the group being built and the number of neurons this group should contain. When neurons are built, each neuron is given a unique identification number, ascending from 0 in the order they are built. 
   - The `<neuron type>` parameter must be equal to one of the following: `basic` `nsn` `calcium_pyr`
 - `connect <connection name (str)> <synapse type> {<from>} {<to>} <optional: probability (float)>`:\
 This command cycles through all the neurons in `<from>` and `<to>` and connects them with a new synapse with the specified probability (if unspecified, it assumes 1).
 - `connect_one_to_one <connection name (str)> <synapse type> {<from>} {<to>} <optional: probability (float)>`:\
 This command pairs up neurons in `<from>` and `<to>` and connects them. `<from>` and `<to>` must have the same number of neurons. 
   - The `<synapse type>` parameter must be equal to one of the following: `basic` `no_fireS` `STDPS` `hat`
   - Note the `{}` notation in choosing  `<from>` and `<to>`. This is a way of specifying specifically which neurons should be used. Neurons can be specified by using the name of a group, by using pythons `:` notation, by specifying individual id numbers, or a combination. Examples are included below. 
   
#####Examples of Model Structure
 - Create two groups of 100 basic neurons each and make random basic connections from one to the other with a probability of 0.5. 
 ```
group basic G1 100
group basic G2 100
connect G1_to_G2 basic {G1} {G2} 0.5
```
 - Create three groups of 100 basic neurons each and make random STDPS connections cycling from one to the other with a probability of 0.2. 
 ```
group basic first 100
group basic second 100
group basic third 100
connect C1 STDPS {first} {second} 0.2
connect C2 STDPS {second} {third} 0.2
connect C3 STDPS {third} {first} 0.2
```
 - Create a single group of 20 neurons and connect the first 10 to the second 10 with one to one synapses 
 ```
group basic Grp 20
connect_one_to_one syn basic {0:10} {10:20}
```
 - Create a single group of 3 neurons and make guaranteed connections cycling from one to the other. 
 ```
group basic Cycle 3
connect C1 basic {0} {1}
connect C2 basic {1} {2} 1.0
connect C3 basic {2} {0}
# note that the 1.0 is optional. 
```
####Parameters:
Parameters is used to specify parameter values for neurons and connections. It is also used to specify external inputs. 
#####Neuron and connection parameter commands:
 - `edit_neurons {<neurons to edit>} <param 1 name> <param 1 value>, <param 2 name> <param 2 value>, ...`\
 This command sets the parameter values for a group of neurons, for any number of specified parameters. Every type of neuron has different parameters which will be covered later. 
    - Note the `{}` notation in choosing  `<from>` and `<to>`. This is a way of specifying specifically which neurons should be used. Neurons can be specified by using the name of a group, by using pythons `:` notation, by specifying individual id numbers, or a combination. Examples of use are included above. 
 - `edit_connection <connection to edit (connection name)> <param 1 name> <param 1 value>, <param 2 name> <param 2 value>, ...`\
 This command sets the parameter values for a connection, for any number of specified parameters. Every type of synapse has different parameters which will be covered later. 

#####External stimulus parameter commands:
 - `estim {<neurons to stimulate>} {<timesteps to stimulate>} <stimulus voltage (float)>`\
 The command will present a constant external stimulus, of the specified value, to the specified neurons at the specified times. 
 - `ostim {<neurons to stimulate>} {<timesteps to stimulate>} <max stimulus volatage (float)> <duration (int)> <centered on which neuron (int)> <standard deviation (int)>`\
 This command will present stimulus in a normal distribution fashion, centered on one neuron. It will only effect the specified neurons and will last for the specified duration (`{<timesteps to stimulate>}` here refers to the start time of this stimulus). The center neuron will recieve the maximum stimulus, and the stimulus will drop off for neurons further out based on the standard deviation. 
 - `sniff {<neurons to stimulate>} {<timesteps to stimulate>} <max stimulus volatage (float)> <frequency> <centered on which neuron (int)> <standard deviation (int)>`\
 This command attempts to replicate the stimulation received by the olfactory bulb due to respiration. The stimulus rises with inhalation and falls with exhalation, following a sinusoidal pattern with the specified frequency. Furthermore, the stimulus is also presented in a normal distribution, centered on one neuron. At the peak of inhalation, the center neuron will receive the maximum stimulus, and this stimulus will drop off for other neurons based on the standard deviation. 
 
 #####Examples of external stimulus:
 TODO (with images)
 ###Types of Neurons and Synapses: 
 TODO
 ###Plotting and saving data:
 TODO (with images)
 ##Examples:
 TODO (with images)